<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <script>
        (function() {
            if (window.innerWidth < 1024) {
                const viewport = document.querySelector("meta[name=viewport]");
                viewport.setAttribute('content', 'width=1280, initial-scale=0.3, maximum-scale=1.0, user-scalable=yes');
            }
        })();
    </script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EDU-PORTAL Pro - Système Multiservices</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.ckeditor.com/ckeditor5/39.0.1/classic/ckeditor.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap');
        
        body { 
            font-family: 'Poppins', sans-serif; 
            -webkit-user-select: none; user-select: none; 
            background: #f8fafc;
        }

        /* Design Pro & Couleurs Dynamiques */
        .gradient-brand { background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); }
        .sidebar-link { transition: all 0.3s; border-radius: 8px; margin-bottom: 4px; padding: 10px; display: flex; align-items: center; gap: 10px; font-size: 0.85rem;}
        .sidebar-link:hover { background-color: #eff6ff; color: #1e3a8a; transform: translateX(5px); }
        .sidebar-link.active { background-color: #1e3a8a; color: white; }
        
        .hidden { display: none !important; }
        .ck-editor__editable { min-height: 250px; border-radius: 0 0 12px 12px !important; }
        
        /* Menu Horizontal Pro */
        .nav-main { background: white; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        .nav-item { position: relative; padding: 1rem 0.5rem; font-weight: 600; color: #475569; transition: 0.3s; font-size: 0.9rem; cursor: pointer; }
        .nav-item:hover { color: #2563eb; }
        .nav-item.active::after { content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 3px; background: #2563eb; }

        /* Bloc Présentation Accueil */
        .hero-section { background: linear-gradient(rgba(30, 58, 138, 0.9), rgba(30, 58, 138, 0.9)), url('https://images.unsplash.com/photo-1524178232363-1fb2b075b655?auto=format&fit=crop&q=80'); background-size: cover; background-position: center; }

        /* Styles Contenu */
        .h1-style { font-size: 2rem; font-weight: 800; color: #1e3a8a; margin: 1.5rem 0; border-left: 6px solid #2563eb; padding-left: 1rem; }
        .h2-style { font-size: 1.5rem; font-weight: 700; color: #3b82f6; margin: 1.2rem 0; }
        .h3-style { font-size: 1.2rem; font-weight: 600; color: #64748b; text-transform: uppercase; }

        .prep-table { width: 100%; border-collapse: collapse; font-size: 12px; background: white; }
        .prep-table th, .prep-table td { border: 1px solid #cbd5e1; padding: 12px; }
        
        /* Notifications */
        .notif-badge { position: absolute; top: -5px; right: -5px; background: #ef4444; color: white; font-size: 10px; padding: 2px 6px; border-radius: 50%; border: 2px solid white; }
    </style>
</head>
<body class="min-h-screen" oncontextmenu="return false;">

    <header class="nav-main sticky top-0 z-50">
        <div class="container mx-auto px-4 flex justify-between items-center h-16">
            <div class="flex items-center gap-3 cursor-pointer" onclick="showSection('student-login')">
                <div class="gradient-brand p-2 rounded-xl"><i class="fas fa-bolt text-white text-xl"></i></div>
                <span class="text-xl font-bold tracking-tighter text-blue-900">EDU-DYNAMIC <span class="text-blue-500 text-sm font-normal">v2.0</span></span>
            </div>

            <nav id="horizontal-menu" class="hidden flex gap-6">
                <div class="nav-item active" onclick="filterByGlobalCategory('Académique')"><i class="fas fa-book-open mr-2"></i>Cours</div>
                <div class="nav-item" onclick="filterByGlobalCategory('Biblique')"><i class="fas fa-cross mr-2"></i>Contenu Biblique</div>
                <div class="nav-item" onclick="filterByGlobalCategory('Leadership')"><i class="fas fa-users-cog mr-2"></i>Leadership</div>
                <div class="nav-item" onclick="filterByGlobalCategory('Formations')"><i class="fas fa-certificate mr-2"></i>Formations</div>
            </nav>

            <div class="flex items-center gap-4">
                <button id="btn-notif-admin" onclick="switchTab('tab-notifs')" class="hidden relative p-2 text-gray-500 hover:text-red-600 transition">
                    <i class="fas fa-bell text-xl"></i>
                    <span id="notif-count" class="notif-badge hidden">0</span>
                </button>
                <button id="btn-admin-access" onclick="showSection('login-admin')" class="text-sm font-semibold text-blue-600 border border-blue-600 px-4 py-1.5 rounded-full hover:bg-blue-600 hover:text-white transition">Admin</button>
                <button id="btn-logout" onclick="location.reload()" class="hidden text-sm font-semibold text-red-500"><i class="fas fa-power-off"></i></button>
            </div>
        </div>
    </header>

    <section id="student-login">
        <div class="hero-section text-white py-20 px-4">
            <div class="container mx-auto max-w-4xl text-center">
                <h1 class="text-4xl md:text-6xl font-extrabold mb-6">L'Excellence Éducative & Spirituelle</h1>
                <p class="text-lg md:text-xl text-blue-100 mb-8 leading-relaxed">Bienvenue sur votre plateforme dynamique de partage de connaissances. Nous fusionnons l'académique, le leadership et l'éveil spirituel pour former les leaders de demain. Accédez à vos ressources, vidéos et formations certifiantes en un clic.</p>
                <div class="flex justify-center gap-4">
                    <a href="#login-form" class="bg-blue-500 hover:bg-blue-600 px-8 py-3 rounded-full font-bold shadow-lg transition">Accéder au Portail</a>
                </div>
            </div>
        </div>

        <div id="login-form" class="max-w-md mx-auto -mt-10 p-8 bg-white rounded-3xl shadow-2xl relative z-10 border border-gray-100">
            <div class="text-center mb-6">
                <h2 class="text-2xl font-bold text-slate-800">Espace Membre</h2>
                <p class="text-slate-400 text-sm">Identifiez-vous pour continuer</p>
            </div>
            <div class="space-y-4">
                <div class="relative">
                    <i class="fas fa-user absolute left-4 top-4 text-gray-400"></i>
                    <input type="text" id="stu-id" placeholder="Identifiant" class="w-full pl-12 p-3.5 bg-gray-50 border border-gray-200 rounded-2xl outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="relative">
                    <i class="fas fa-lock absolute left-4 top-4 text-gray-400"></i>
                    <input type="password" id="stu-pass" placeholder="Mot de passe" class="w-full pl-12 p-3.5 bg-gray-50 border border-gray-200 rounded-2xl outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <button onclick="loginUser()" class="w-full gradient-brand text-white py-4 rounded-2xl font-bold shadow-xl hover:opacity-90 transition">Démarrer la session</button>
            </div>
            <p id="stu-error" class="text-red-500 mt-4 text-xs hidden text-center font-bold">Identifiants incorrects ou accès restreint.</p>
            
            <div class="mt-8 pt-6 border-t border-gray-100 text-center">
                <p class="text-[10px] text-gray-400 uppercase tracking-widest mb-1">Support Technique</p>
                <p class="text-sm font-semibold text-slate-700">Fanera Christian | <span class="text-blue-500">033 64 851 37</span></p>
            </div>
        </div>
    </section>

    <section id="login-admin" class="hidden max-w-md mx-auto mt-20 p-10 bg-white rounded-3xl shadow-2xl border-t-8 border-blue-900">
        <div class="text-center mb-8">
            <div class="w-16 h-16 bg-blue-50 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-shield-halved text-3xl text-blue-900"></i>
            </div>
            <h2 class="text-2xl font-bold">Console Sécurisée</h2>
        </div>
        <input type="password" id="admin-pass" placeholder="Entrer le code maître" class="w-full p-4 bg-gray-50 border rounded-2xl mb-4 focus:ring-2 focus:ring-blue-900 outline-none">
        <button onclick="checkAdminPass()" class="w-full bg-blue-900 text-white py-4 rounded-2xl font-bold">Authentifier</button>
    </section>

    <section id="student-view" class="hidden container mx-auto mt-6 flex flex-col md:flex-row gap-6 px-4 pb-20">
        <aside class="md:w-1/4 space-y-4">
            <div class="bg-white p-5 rounded-3xl shadow-sm border border-gray-100 sticky top-24">
                <h3 id="sidebar-title" class="font-bold text-blue-900 mb-4 flex items-center gap-2">
                    <i class="fas fa-stream"></i> Académique
                </h3>
                <div id="course-list-sidebar" class="space-y-1 max-h-[60vh] overflow-y-auto pr-2">
                    </div>
            </div>
        </aside>
        
        <main class="md:w-3/4">
            <div class="bg-white p-6 md:p-12 rounded-3xl shadow-sm border border-gray-100 min-h-[600px] relative">
                <div id="user-content-area">
                    <div class="flex flex-col items-center justify-center h-96 text-gray-300">
                        <i class="fas fa-lightbulb text-7xl mb-6 opacity-20"></i>
                        <p class="text-lg">Sélectionnez une ressource dans le menu latéral</p>
                    </div>
                </div>
                
                <div id="user-prep-area" class="hidden">
                    <div class="flex justify-between items-center mb-8 bg-blue-50 p-4 rounded-2xl">
                        <div>
                            <h2 class="text-xl font-bold text-blue-900">Fiche de Préparation</h2>
                            <p class="text-xs text-blue-600">Document pédagogique officiel</p>
                        </div>
                        <button onclick="requestPdfDownload()" class="bg-white text-blue-600 border border-blue-600 px-6 py-2 rounded-xl font-bold hover:bg-blue-600 hover:text-white transition shadow-sm">
                            <i class="fas fa-download mr-2"></i>Demander PDF
                        </button>
                    </div>
                    <div id="prep-sheet-render"></div>
                </div>
            </div>
        </main>
    </section>

    <section id="admin-panel" class="hidden container mx-auto mt-8 px-4 pb-20">
        <div class="bg-white rounded-3xl shadow-2xl overflow-hidden border border-gray-100">
            <div class="bg-slate-900 text-white p-6 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <i class="fas fa-terminal text-blue-500"></i>
                    <h2 class="font-bold uppercase tracking-widest text-sm">Administration Système</h2>
                </div>
                <button onclick="location.reload()" class="bg-red-500/20 text-red-400 hover:bg-red-500 hover:text-white px-4 py-2 rounded-xl text-xs font-bold transition">Déconnexion</button>
            </div>

            <div class="flex border-b bg-gray-50 overflow-x-auto">
                <button onclick="switchTab('tab-create')" id="btn-tab-create" class="p-4 px-8 transition tab-active whitespace-nowrap font-semibold">Éditeur</button>
                <button onclick="switchTab('tab-prep')" id="btn-tab-prep" class="p-4 px-8 transition whitespace-nowrap font-semibold">Fiches Prep</button>
                <button onclick="switchTab('tab-users')" id="btn-tab-users" class="p-4 px-8 transition whitespace-nowrap font-semibold text-blue-600">Utilisateurs & Accès</button>
                <button onclick="switchTab('tab-notifs')" id="btn-tab-notifs" class="p-4 px-8 transition whitespace-nowrap font-semibold text-red-500">Requêtes PDF <span id="badge-tab-notif" class="ml-2 bg-red-500 text-white px-2 py-0.5 rounded-full text-[10px] hidden">0</span></button>
                <button onclick="switchTab('tab-library')" id="btn-tab-library" class="p-4 px-8 transition whitespace-nowrap font-semibold">Bibliothèque</button>
            </div>

            <div class="p-8">
                <div id="tab-create" class="admin-tab">
                    <div class="max-w-5xl mx-auto space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 bg-blue-50 p-6 rounded-2xl border border-blue-100">
                            <div>
                                <label class="text-[10px] font-bold uppercase text-blue-400">Catégorie</label>
                                <select id="adm-category" class="w-full p-2 border rounded-xl bg-white">
                                    <option>Académique</option><option>Biblique</option><option>Leadership</option><option>Formations</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-[10px] font-bold uppercase text-blue-400">Classe / Groupe</label>
                                <input type="text" id="adm-classe" placeholder="Ex: 3ème ou Groupe Jeunes" class="w-full p-2 border rounded-xl bg-white">
                            </div>
                            <div>
                                <label class="text-[10px] font-bold uppercase text-blue-400">Matière / Thème</label>
                                <input type="text" id="adm-matiere" placeholder="Ex: Maths" class="w-full p-2 border rounded-xl bg-white">
                            </div>
                            <div>
                                <label class="text-[10px] font-bold uppercase text-blue-400">Cycle</label>
                                <select id="adm-cycle" class="w-full p-2 border rounded-xl bg-white">
                                    <option>Primaire</option><option>Collège</option><option>Lycée</option><option>Spécial</option>
                                </select>
                            </div>
                        </div>

                        <input type="text" id="adm-chapitre" placeholder="TITRE DU CONTENU..." class="w-full p-4 text-3xl font-black text-blue-900 border-b-4 border-blue-100 outline-none">
                        
                        <div id="dynamic-sections-container" class="space-y-8"></div>
                        
                        <div class="flex gap-4 pt-8 border-t">
                            <button onclick="addSection()" class="bg-blue-100 text-blue-700 px-6 py-3 rounded-2xl font-bold hover:bg-blue-200 transition">+ Nouveau Bloc</button>
                            <button onclick="publishContent()" class="bg-blue-600 text-white px-10 py-3 rounded-2xl font-bold shadow-lg ml-auto hover:bg-blue-700">PUBLIER LE CONTENU</button>
                            <button onclick="resetCourseForm()" id="btn-cancel-edit" class="hidden bg-gray-200 text-gray-700 px-6 py-3 rounded-2xl font-bold">ANNULER</button>
                            <input type="hidden" id="edit-lesson-id">
                        </div>
                    </div>
                </div>

                <div id="tab-users" class="admin-tab hidden">
                    <div class="grid grid-cols-1 xl:grid-cols-3 gap-8">
                        <div class="bg-slate-50 p-8 rounded-3xl border border-gray-200">
                            <h3 class="font-bold text-xl mb-6 text-slate-800">Ajouter un Membre</h3>
                            <div class="space-y-5">
                                <input type="text" id="new-user-name" placeholder="Nom complet" class="w-full p-3.5 border rounded-2xl bg-white">
                                <select id="new-user-type" class="w-full p-3.5 border rounded-2xl bg-white">
                                    <option value="Eleve">Élève / Apprenant</option>
                                    <option value="Enseignant">Enseignant / Coach</option>
                                </select>
                                <div class="bg-white p-4 rounded-2xl border border-dashed border-blue-200">
                                    <p class="text-[10px] font-bold text-blue-500 mb-3 uppercase">Autorisations d'Accès</p>
                                    <div class="grid grid-cols-2 gap-2 text-xs font-semibold">
                                        <label class="flex items-center gap-2"><input type="checkbox" value="Académique" class="user-access"> Académique</label>
                                        <label class="flex items-center gap-2"><input type="checkbox" value="Biblique" class="user-access"> Biblique</label>
                                        <label class="flex items-center gap-2"><input type="checkbox" value="Leadership" class="user-access"> Leadership</label>
                                        <label class="flex items-center gap-2"><input type="checkbox" value="Formations" class="user-access"> Formations</label>
                                    </div>
                                </div>
                                <input type="text" id="new-user-resp" placeholder="Référence (ex: Terminale S)" class="w-full p-3.5 border rounded-2xl bg-white">
                                <button onclick="addNewUser()" class="w-full gradient-brand text-white py-4 rounded-2xl font-bold shadow-lg">Créer le compte</button>
                            </div>
                        </div>
                        <div class="xl:col-span-2 overflow-x-auto rounded-3xl border">
                            <table class="w-full text-left bg-white">
                                <thead class="bg-slate-900 text-white">
                                    <tr>
                                        <th class="p-5">Identité</th>
                                        <th class="p-5">Accès & Rôle</th>
                                        <th class="p-5">Code Téléch.</th>
                                        <th class="p-5">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="students-table-body" class="divide-y text-sm"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="tab-notifs" class="admin-tab hidden">
                    <div class="max-w-4xl mx-auto">
                        <h3 class="font-bold text-2xl mb-6 text-red-600 flex items-center gap-3">
                            <i class="fas fa-hand-paper"></i> Demandes de téléchargement en attente
                        </h3>
                        <div id="notifs-container" class="space-y-4">
                            </div>
                    </div>
                </div>

                <div id="tab-prep" class="admin-tab hidden">
                    <div class="max-w-5xl mx-auto bg-slate-50 p-8 rounded-3xl border">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div>
                                <label class="text-xs font-black text-slate-500 mb-2 block uppercase">Chapitre lié</label>
                                <select id="prep-lesson-id" class="w-full p-3 border rounded-xl" onchange="loadExistingPrep(this.value)"></select>
                            </div>
                            <div>
                                <label class="text-xs font-black text-slate-500 mb-2 block uppercase">Date</label>
                                <input type="date" id="prep-date" class="w-full p-3 border rounded-xl">
                            </div>
                        </div>
                        <div id="prep-steps-container" class="space-y-4"></div>
                        <button onclick="addPrepStep()" class="mt-4 text-sm bg-blue-100 text-blue-600 px-4 py-2 rounded-xl font-bold">+ Ajouter Phase</button>
                        <button onclick="savePrepSheet()" class="w-full mt-10 gradient-brand text-white py-4 rounded-2xl font-bold">ENREGISTRER LA FICHE</button>
                    </div>
                </div>

                <div id="tab-library" class="admin-tab hidden">
                    <div class="flex gap-4 mb-6">
                        <input type="text" id="lib-search" oninput="renderLessonsTable()" placeholder="Rechercher dans la bibliothèque..." class="flex-1 p-3 border rounded-2xl">
                    </div>
                    <div class="overflow-x-auto rounded-3xl border">
                        <table class="w-full text-left bg-white">
                            <thead class="bg-gray-100 font-bold text-xs uppercase text-gray-600">
                                <tr>
                                    <th class="p-5">Catégorie</th>
                                    <th class="p-5">Titre du Chapitre</th>
                                    <th class="p-5">Groupe</th>
                                    <th class="p-5 text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="lessons-table-body" class="divide-y text-sm"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
        import { getDatabase, ref, set, push, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBexDEiFMC98r8ZqJjbfNazsKYOiXB1dck",
            authDomain: "edu-portal-3db68.firebaseapp.com",
            databaseURL: "https://edu-portal-3db68-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "edu-portal-3db68",
            storageBucket: "edu-portal-3db68.firebasestorage.app",
            messagingSenderId: "58173024956",
            appId: "1:58173024956:web:17d27c8e7b495a48a7beb9"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // Global State
        window.users = [];
        window.publishedLessons = [];
        window.prepSheets = {};
        window.currentUser = null;
        window.currentCategory = 'Académique';
        window.editors = {};
        window.sectionCount = 0;

        // --- CORE LOGIC ---

        onValue(ref(db, 'users'), (snapshot) => {
            const data = snapshot.val();
            window.users = data ? Object.keys(data).map(k => ({...data[k], fbKey: k})) : [];
            renderUserTable();
        });

        onValue(ref(db, 'lessons'), (snapshot) => {
            const data = snapshot.val();
            window.publishedLessons = data ? Object.keys(data).map(k => ({...data[k], fbKey: k})) : [];
            renderLessonsTable();
            populatePrepSelect();
            if(window.currentUser) updateStudentSidebar();
        });

        onValue(ref(db, 'requests'), (snapshot) => {
            const data = snapshot.val();
            renderNotifs(data);
        });

        window.loginUser = () => {
            const id = document.getElementById('stu-id').value;
            const pass = document.getElementById('stu-pass').value;
            const user = window.users.find(u => u.id === id && u.pass === pass);
            
            if(user && user.active) {
                window.currentUser = user;
                showSection('student-view');
                document.getElementById('horizontal-menu').classList.remove('hidden');
                document.getElementById('btn-logout').classList.remove('hidden');
                document.getElementById('btn-admin-access').classList.add('hidden');
                filterByGlobalCategory('Académique');
            } else {
                document.getElementById('stu-error').classList.remove('hidden');
            }
        };

        window.filterByGlobalCategory = (cat) => {
            window.currentCategory = cat;
            document.querySelectorAll('.nav-item').forEach(el => {
                el.classList.toggle('active', el.textContent.includes(cat));
            });
            document.getElementById('sidebar-title').innerHTML = `<i class="fas fa-stream"></i> ${cat}`;
            updateStudentSidebar();
            
            // Si l'utilisateur n'a pas accès à cette catégorie
            if(window.currentUser && window.currentUser.access && !window.currentUser.access.includes(cat)) {
                document.getElementById('user-content-area').innerHTML = `
                    <div class="text-center p-10">
                        <i class="fas fa-lock text-red-300 text-5xl mb-4"></i>
                        <p class="text-gray-500">Désolé, vous n'avez pas l'autorisation d'accéder au contenu <b>${cat}</b>.</p>
                    </div>`;
            }
        };

        window.updateStudentSidebar = () => {
            const sidebar = document.getElementById('course-list-sidebar');
            sidebar.innerHTML = "";
            
            const filtered = window.publishedLessons.filter(l => 
                l.category === window.currentCategory && 
                (window.currentUser.type === 'Enseignant' || l.classe === window.currentUser.resp)
            );

            if(filtered.length === 0) {
                sidebar.innerHTML = "<p class='text-xs text-gray-400 p-4'>Aucun contenu disponible.</p>";
                return;
            }

            filtered.forEach(lesson => {
                sidebar.insertAdjacentHTML('beforeend', `
                    <button onclick="viewLesson('${lesson.fbKey}')" class="sidebar-link w-full text-left font-semibold">
                        <i class="fas fa-file-alt text-blue-400"></i>
                        <span>${lesson.chapitre}</span>
                    </button>
                `);
            });
        };

        window.viewLesson = (key) => {
            const l = window.publishedLessons.find(x => x.fbKey === key);
            let html = `<h2 class="h1-style">${l.chapitre}</h2>`;
            l.sections.forEach(s => {
                html += `<div class="mb-10"><h3 class="${s.level}-style">${s.title}</h3><div class="prose max-w-none mt-4">${s.body}</div></div>`;
            });
            document.getElementById('user-content-area').innerHTML = html;
            window.activeLessonKey = key;
        };

        // --- GESTION DES NOTIFICATIONS & PDF ---

        window.requestPdfDownload = () => {
            const code = prompt("Veuillez entrer votre CODE DE TÉLÉCHARGEMENT personnel :");
            if(!code) return;

            if(window.currentUser.downloadCode === code) {
                // Lancer le téléchargement
                const element = document.getElementById('user-content-area');
                html2pdf().from(element).save(`${window.currentUser.name}_cours.pdf`);
            } else {
                // Envoyer requête à l'admin
                alert("Code invalide. Une demande d'autorisation a été envoyée à l'administrateur.");
                push(ref(db, 'requests'), {
                    userId: window.currentUser.fbKey,
                    userName: window.currentUser.name,
                    lessonTitle: "Fiche de préparation",
                    timestamp: Date.now()
                });
            }
        };

        function renderNotifs(requests) {
            const container = document.getElementById('notifs-container');
            const badge = document.getElementById('notif-count');
            const badgeTab = document.getElementById('badge-tab-notif');
            container.innerHTML = "";
            
            if(!requests) {
                badge.classList.add('hidden');
                badgeTab.classList.add('hidden');
                container.innerHTML = "<p class='text-gray-400 italic'>Aucune demande en attente.</p>";
                return;
            }

            const reqList = Object.keys(requests).map(k => ({...requests[k], fbKey: k}));
            badge.innerText = reqList.length;
            badgeTab.innerText = reqList.length;
            badge.classList.remove('hidden');
            badgeTab.classList.remove('hidden');

            reqList.forEach(r => {
                container.insertAdjacentHTML('beforeend', `
                    <div class="bg-white p-5 rounded-2xl border-l-4 border-red-500 shadow-sm flex justify-between items-center">
                        <div>
                            <p class="font-bold text-slate-800">${r.userName}</p>
                            <p class="text-xs text-gray-500">Souhaite télécharger : ${r.lessonTitle}</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="assignCode('${r.userId}', '${r.fbKey}')" class="bg-green-600 text-white px-4 py-2 rounded-xl text-xs font-bold">Attribuer Code</button>
                            <button onclick="deleteRequest('${r.fbKey}')" class="bg-gray-100 text-gray-400 px-4 py-2 rounded-xl text-xs"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                `);
            });
        }

        window.assignCode = (userId, reqId) => {
            const code = Math.random().toString(36).substring(2, 7).toUpperCase();
            update(ref(db, 'users/' + userId), { downloadCode: code }).then(() => {
                alert("Code " + code + " attribué à l'utilisateur.");
                remove(ref(db, 'requests/' + reqId));
            });
        };

        // --- GESTION ADMIN UTILISATEURS ---

        window.addNewUser = () => {
            const name = document.getElementById('new-user-name').value;
            const type = document.getElementById('new-user-type').value;
            const resp = document.getElementById('new-user-resp').value;
            const access = Array.from(document.querySelectorAll('.user-access:checked')).map(cb => cb.value);

            if(!name || access.length === 0) { alert("Nom et au moins 1 accès requis"); return; }

            const id = name.toLowerCase().split(' ')[0] + Math.floor(100 + Math.random()*899);
            const pass = Math.random().toString(36).slice(-5).toUpperCase();

            push(ref(db, 'users'), {
                name, type, resp, access, id, pass, active: true, downloadCode: "---"
            });
            
            alert("Compte créé avec succès !");
            document.getElementById('new-user-name').value = "";
        };

        window.renderUserTable = () => {
            const tbody = document.getElementById('students-table-body');
            tbody.innerHTML = window.users.map(u => `
                <tr>
                    <td class="p-5">
                        <p class="font-bold">${u.name}</p>
                        <p class="text-[10px] text-blue-500 uppercase">${u.id} / ${u.pass}</p>
                    </td>
                    <td class="p-5">
                        <p class="text-xs font-semibold">${u.type}</p>
                        <p class="text-[9px] text-gray-400">${u.access ? u.access.join(', ') : 'Aucun'}</p>
                    </td>
                    <td class="p-5"><span class="bg-blue-50 text-blue-700 px-3 py-1 rounded-full font-mono text-xs">${u.downloadCode || '---'}</span></td>
                    <td class="p-5">
                        <div class="flex gap-2">
                            <button onclick="toggleUser('${u.fbKey}', ${u.active})" class="text-xs ${u.active?'text-orange-500':'text-green-500'}">${u.active?'Bloquer':'Activer'}</button>
                            <button onclick="deleteUser('${u.fbKey}')" class="text-red-500"><i class="fas fa-trash"></i></button>
                        </div>
                    </td>
                </tr>
            `).join('');
        };

        // --- LOGIQUE ÉDITEUR (Original amélioré) ---

        window.addSection = (title = "", content = "", level = "h1") => {
            window.sectionCount++;
            const id = 'editor-' + window.sectionCount;
            const html = `
                <div id="block-${window.sectionCount}" class="p-6 bg-white border border-gray-100 rounded-3xl shadow-sm relative group">
                    <button onclick="this.parentElement.remove()" class="absolute -top-3 -right-3 bg-red-500 text-white w-8 h-8 rounded-full opacity-0 group-hover:opacity-100 transition shadow-lg">×</button>
                    <div class="flex gap-4 mb-4">
                        <select class="p-3 border rounded-2xl text-xs bg-slate-50 font-bold">
                            <option value="h1" ${level=='h1'?'selected':''}>TITRE I</option>
                            <option value="h2" ${level=='h2'?'selected':''}>Sous-titre A</option>
                            <option value="h3" ${level=='h3'?'selected':''}>Petit 1.</option>
                        </select>
                        <input type="text" value="${title}" placeholder="Titre du bloc..." class="flex-1 p-3 font-bold border-b-2 outline-none text-blue-900">
                    </div>
                    <textarea id="${id}">${content}</textarea>
                </div>`;
            document.getElementById('dynamic-sections-container').insertAdjacentHTML('beforeend', html);
            ClassicEditor.create(document.querySelector(`#${id}`)).then(ed => window.editors[id] = ed);
        };

        window.publishContent = () => {
            const key = document.getElementById('edit-lesson-id').value;
            const lesson = {
                category: document.getElementById('adm-category').value,
                cycle: document.getElementById('adm-cycle').value,
                classe: document.getElementById('adm-classe').value,
                matiere: document.getElementById('adm-matiere').value,
                chapitre: document.getElementById('adm-chapitre').value,
                sections: []
            };
            
            document.querySelectorAll('#dynamic-sections-container > div').forEach(div => {
                const edId = div.querySelector('textarea').id;
                lesson.sections.push({
                    level: div.querySelector('select').value,
                    title: div.querySelector('input').value,
                    body: window.editors[edId].getData()
                });
            });

            const refL = key ? ref(db, 'lessons/' + key) : push(ref(db, 'lessons'));
            set(refL, lesson).then(() => { 
                alert("Contenu synchronisé avec succès !"); 
                resetCourseForm(); 
                switchTab('tab-library'); 
            });
        };

        // --- HELPERS NAVIGATION ---
        window.showSection = (id) => {
            document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        };

        window.switchTab = (tabId) => {
            document.querySelectorAll('.admin-tab').forEach(t => t.classList.add('hidden'));
            document.querySelectorAll('[id^="btn-tab-"]').forEach(b => b.classList.remove('tab-active', 'bg-white', 'text-blue-600'));
            document.getElementById(tabId).classList.remove('hidden');
            document.getElementById('btn-' + tabId).classList.add('tab-active', 'bg-white', 'text-blue-600');
        };

        window.checkAdminPass = () => {
            if(document.getElementById('admin-pass').value === 'Tsiry@1963!') {
                showSection('admin-panel');
                if(window.sectionCount === 0) addSection();
                document.getElementById('btn-notif-admin').classList.remove('hidden');
            }
        };

        window.deleteUser = (k) => { if(confirm("Supprimer définitivement cet utilisateur ?")) remove(ref(db, 'users/' + k)); };
        window.toggleUser = (k, s) => update(ref(db, 'users/' + k), { active: !s });
        window.deleteRequest = (k) => remove(ref(db, 'requests/' + k));

        // Initialisation du premier bloc au chargement si admin
        window.resetCourseForm = () => {
            document.getElementById('dynamic-sections-container').innerHTML = "";
            document.getElementById('edit-lesson-id').value = "";
            document.getElementById('adm-chapitre').value = "";
            window.sectionCount = 0; window.editors = {};
            addSection();
        };

        window.renderLessonsTable = () => {
            const query = document.getElementById('lib-search')?.value.toLowerCase() || "";
            document.getElementById('lessons-table-body').innerHTML = window.publishedLessons
                .filter(l => l.chapitre.toLowerCase().includes(query))
                .map(l => `
                <tr>
                    <td class="p-5 font-bold text-blue-600">${l.category}</td>
                    <td class="p-5"><b>${l.chapitre}</b></td>
                    <td class="p-5 text-xs">${l.classe} / ${l.matiere}</td>
                    <td class="p-5 text-center">
                        <button onclick="editLesson('${l.fbKey}')" class="text-blue-600 p-2"><i class="fas fa-edit"></i></button>
                        <button onclick="deleteLesson('${l.fbKey}')" class="text-red-500 p-2"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
        };

        // --- FICHE PREP AUTO-FILL (Filtre par liste déroulante) ---
        window.populatePrepSelect = () => {
            const s = document.getElementById('prep-lesson-id');
            s.innerHTML = '<option value="">-- Sélectionner un contenu --</option>' + 
                window.publishedLessons.map(l => `<option value="${l.fbKey}">${l.category} > ${l.chapitre}</option>`).join('');
        };

        // ... Fonctions de prep existantes conservées ...
        window.addPrepStep = (phase = "", teacher = "", student = "", med = "") => {
            const container = document.getElementById('prep-steps-container');
            const html = `
                <div class="grid grid-cols-1 md:grid-cols-4 gap-3 bg-white p-4 border rounded-2xl shadow-sm">
                    <input type="text" placeholder="Phase" class="p-2 border rounded-xl text-xs" value="${phase}">
                    <textarea placeholder="Enseignant" class="p-2 border rounded-xl text-xs h-20">${teacher}</textarea>
                    <textarea placeholder="Élève" class="p-2 border rounded-xl text-xs h-20">${student}</textarea>
                    <textarea placeholder="Médiation" class="p-2 border rounded-xl text-xs h-20">${med}</textarea>
                </div>`;
            container.insertAdjacentHTML('beforeend', html);
        };
    </script>
</body>
</html>
