<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Système Scolaire Dynamique - Cloud Sync</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.ckeditor.com/ckeditor5/39.0.1/classic/ckeditor.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        
        body { 
            font-family: 'Inter', sans-serif; 
            -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; 
        }
        
        .sidebar-link { transition: all 0.3s; border-radius: 8px; margin-bottom: 4px; }
        .sidebar-link:hover { background-color: #e2e8f0; color: #1e3a8a; cursor: pointer; transform: translateX(5px); }
        .hidden { display: none !important; }
        .ck-editor__editable { min-height: 150px; }
        
        /* Styles Fiche de Préparation */
        .fiche-table { width: 100%; border-collapse: collapse; background: white; font-size: 12px; }
        .fiche-table th, .fiche-table td { border: 1px solid #333; padding: 8px; vertical-align: top; }
        .fiche-header { background: #f8fafc; font-weight: bold; text-align: center; }
        
        .tab-nav-active { border-bottom: 3px solid #3b82f6; color: #1e3a8a; font-weight: 700; }
        
        @media print {
            .no-print { display: none; }
            body { -webkit-user-select: auto; user-select: auto; }
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 min-h-screen" oncontextmenu="return false;">

    <nav class="bg-gradient-to-r from-blue-900 to-indigo-900 text-white p-4 sticky top-0 z-50 shadow-lg">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center gap-2">
                <div class="bg-white p-2 rounded-lg">
                    <i class="fas fa-graduation-cap text-blue-900 text-xl"></i>
                </div>
                <div>
                    <h1 class="text-xl font-extrabold tracking-tight">EDU-PORTAL</h1>
                    <p class="text-[10px] text-blue-200">By T. Fanera Christian</p>
                </div>
            </div>
            <div id="nav-links" class="flex gap-2 md:gap-4">
                <button onclick="showSection('student-login')" class="text-sm hover:bg-blue-800 px-3 py-2 rounded-lg transition">Connexion</button>
                <button onclick="showSection('login-admin')" class="text-sm bg-white/10 hover:bg-white/20 px-3 py-2 rounded-lg transition">Admin</button>
            </div>
        </div>
    </nav>

    <section id="student-login" class="max-w-md mx-auto mt-20 p-8 bg-white rounded-2xl shadow-2xl border border-gray-100">
        <div class="text-center mb-8">
            <h2 class="text-3xl font-bold text-slate-800">Espace Utilisateur</h2>
            <p class="text-slate-500 mt-2">Élèves et Enseignants</p>
        </div>
        <div class="space-y-4">
            <input type="text" id="stu-id" placeholder="Identifiant" class="w-full p-3 border rounded-xl outline-none focus:ring-2 focus:ring-blue-500">
            <input type="password" id="stu-pass" placeholder="Mot de passe" class="w-full p-3 border rounded-xl outline-none focus:ring-2 focus:ring-blue-500">
            <button onclick="loginUser()" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-blue-700 transition">Se connecter</button>
        </div>
        <p id="stu-error" class="text-red-500 mt-4 text-sm hidden text-center">Identifiant ou mot de passe incorrect.</p>
    </section>

    <section id="login-admin" class="hidden max-w-md mx-auto mt-20 p-8 bg-white rounded-2xl shadow-2xl border-t-4 border-red-600">
        <div class="text-center mb-8">
            <i class="fas fa-shield-alt text-4xl text-red-600 mb-2"></i>
            <h2 class="text-2xl font-bold">Administration</h2>
        </div>
        <input type="password" id="admin-pass" placeholder="Code secret" class="w-full p-3 border rounded-xl mb-4 outline-none focus:ring-2 focus:ring-red-500">
        <button onclick="checkAdminPass()" class="w-full bg-red-600 text-white py-3 rounded-xl font-bold hover:bg-red-700 transition">Accéder</button>
    </section>

    <section id="student-view" class="hidden min-h-screen">
        <div class="bg-white border-b shadow-sm sticky top-16 z-40">
            <div class="container mx-auto flex gap-6 px-4">
                <button id="btn-view-cours" onclick="toggleUserSubTab('cours')" class="py-4 px-2 tab-nav-active">Cours</button>
                <button id="btn-view-fiche" onclick="toggleUserSubTab('fiche')" class="py-4 px-2 text-gray-500">Fiche de préparation</button>
            </div>
        </div>

        <div class="container mx-auto mt-6 flex flex-col md:flex-row gap-6 px-4">
            <aside class="md:w-1/4 bg-white p-6 rounded-2xl shadow-md h-fit md:sticky md:top-36 border border-gray-100">
                <h3 class="font-bold text-sm uppercase mb-4 text-blue-900">Chapitres</h3>
                <ul id="course-list-sidebar" class="space-y-1"></ul>
            </aside>
            
            <main class="md:w-3/4 bg-white p-6 md:p-10 rounded-2xl shadow-md border border-gray-100 mb-10">
                <div id="user-content-area">
                    <div class="text-center text-gray-400 py-20">
                        <i class="fas fa-book-open text-5xl mb-4"></i>
                        <p>Sélectionnez un chapitre pour commencer</p>
                    </div>
                </div>
            </main>
        </div>
    </section>

    <section id="admin-panel" class="hidden container mx-auto mt-8 px-4 pb-20">
        <div class="bg-white rounded-2xl shadow-xl overflow-hidden border border-gray-200">
            <div class="bg-slate-800 text-white p-4 flex justify-between items-center">
                <h2 class="font-bold flex items-center gap-2"><i class="fas fa-tools"></i> Console de gestion</h2>
                <button onclick="location.reload()" class="text-xs bg-red-500 px-3 py-1 rounded">Quitter</button>
            </div>

            <div class="flex border-b overflow-x-auto bg-gray-50">
                <button onclick="switchTab('tab-create')" id="btn-tab-create" class="p-4 whitespace-nowrap tab-active border-b-2 border-red-500 font-bold">Création de Cours</button>
                <button onclick="switchTab('tab-fiche')" id="btn-tab-fiche" class="p-4 whitespace-nowrap">Fiches de Préparation</button>
                <button onclick="switchTab('tab-users')" id="btn-tab-users" class="p-4 whitespace-nowrap">Utilisateurs</button>
            </div>

            <div class="p-6">
                <div id="tab-create" class="admin-tab">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <input type="text" id="adm-classe" placeholder="Classe (Ex: 3ème)" class="p-2 border rounded">
                        <input type="text" id="adm-matiere" placeholder="Matière" class="p-2 border rounded">
                        <input type="text" id="adm-chapitre" placeholder="Titre du Chapitre" class="p-2 border rounded font-bold">
                    </div>
                    <div id="dynamic-sections-container" class="space-y-4 mb-6"></div>
                    <div class="flex gap-2">
                        <button onclick="addSection()" class="bg-indigo-600 text-white px-4 py-2 rounded text-sm">+ Ajouter un bloc</button>
                        <button onclick="publishContent()" class="bg-green-600 text-white px-6 py-2 rounded text-sm font-bold ml-auto">Enregistrer le cours</button>
                    </div>
                </div>

                <div id="tab-fiche" class="admin-tab hidden">
                    <h3 class="font-bold mb-4 border-b pb-2">Créer une fiche de préparation</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 bg-gray-50 p-4 rounded mb-4">
                        <div>
                            <label class="text-xs font-bold">Associer au chapitre :</label>
                            <select id="fiche-lesson-id" class="w-full p-2 border rounded"></select>
                        </div>
                        <div>
                            <label class="text-xs font-bold">Code de téléchargement (pour l'enseignant) :</label>
                            <input type="text" id="fiche-download-code" placeholder="Ex: PREP2024" class="w-full p-2 border rounded">
                        </div>
                    </div>
                    
                    <div class="space-y-4 bg-white border p-4 rounded shadow-inner">
                        <div class="grid grid-cols-2 gap-2">
                            <input type="text" id="f-niveau" placeholder="Niveau (Clis...)" class="p-2 border">
                            <input type="text" id="f-discipline" placeholder="Discipline" class="p-2 border">
                        </div>
                        <div class="grid grid-cols-1 gap-2">
                            <input type="text" id="f-obj-disc" placeholder="Objectif disciplinaire" class="p-2 border">
                            <input type="text" id="f-obj-lang" placeholder="Objectif langagier" class="p-2 border">
                        </div>
                        <textarea id="f-competences" placeholder="Compétences du socle commun..." class="w-full p-2 border h-20"></textarea>
                        <textarea id="f-phases" placeholder="Détails des phases (Tableau HTML ou Texte)" class="w-full p-2 border h-32"></textarea>
                        <button onclick="saveFiche()" class="w-full bg-blue-600 text-white py-3 rounded font-bold">Enregistrer la Fiche</button>
                    </div>
                </div>

                <div id="tab-users" class="admin-tab hidden">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                            <h4 class="font-bold mb-3">Nouvel utilisateur</h4>
                            <input type="text" id="u-name" placeholder="Nom complet" class="w-full p-2 border rounded mb-2">
                            <select id="u-type" class="w-full p-2 border rounded mb-2">
                                <option value="Eleve">Élève</option>
                                <option value="Enseignant">Enseignant</option>
                            </select>
                            <input type="text" id="u-resp" placeholder="Classe affectée" class="w-full p-2 border rounded mb-3">
                            <button onclick="addNewUser()" class="w-full bg-blue-900 text-white py-2 rounded">Créer</button>
                        </div>
                        <div class="md:col-span-2 overflow-x-auto">
                            <table class="w-full text-left border">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="p-2 text-xs">Nom</th>
                                        <th class="p-2 text-xs">ID/PASS</th>
                                        <th class="p-2 text-xs">Rôle</th>
                                        <th class="p-2 text-xs">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="user-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
        import { getDatabase, ref, set, push, onValue, remove } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBexDEiFMC98r8ZqJjbfNazsKYOiXB1dck",
            authDomain: "edu-portal-3db68.firebaseapp.com",
            databaseURL: "https://edu-portal-3db68-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "edu-portal-3db68",
            storageBucket: "edu-portal-3db68.firebasestorage.app",
            messagingSenderId: "58173024956",
            appId: "1:58173024956:web:17d27c8e7b495a48a7beb9"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        window.editors = {};
        window.sectionCount = 0;
        window.users = [];
        window.lessons = [];
        window.fiches = {};
        window.currentUser = null;
        window.currentLessonKey = null;

        // Sync Data
        onValue(ref(db, 'users'), (snapshot) => {
            const data = snapshot.val();
            window.users = data ? Object.keys(data).map(key => ({...data[key], fbKey: key})) : [];
            renderUserTable();
        });

        onValue(ref(db, 'lessons'), (snapshot) => {
            const data = snapshot.val();
            window.lessons = data ? Object.keys(data).map(key => ({...data[key], fbKey: key})) : [];
            updateFicheSelect();
            if(window.currentUser) updateStudentSidebar();
        });

        onValue(ref(db, 'fiches'), (snapshot) => {
            window.fiches = snapshot.val() || {};
        });

        // Navigation Admin
        window.switchTab = (tabId) => {
            document.querySelectorAll('.admin-tab').forEach(t => t.classList.add('hidden'));
            document.querySelectorAll('[id^="btn-tab-"]').forEach(b => b.classList.remove('border-b-2', 'border-red-500', 'font-bold'));
            document.getElementById(tabId).classList.remove('hidden');
            document.getElementById('btn-' + tabId).classList.add('border-b-2', 'border-red-500', 'font-bold');
        };

        window.showSection = (id) => {
            document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        };

        window.checkAdminPass = () => {
            if(document.getElementById('admin-pass').value === 'Tsiry@1963!') {
                showSection('admin-panel');
                if(window.sectionCount === 0) addSection();
            }
        };

        // Gestion Cours
        window.addSection = (title = "", content = "") => {
            window.sectionCount++;
            const id = 'editor-' + window.sectionCount;
            const container = document.getElementById('dynamic-sections-container');
            const html = `<div id="block-${window.sectionCount}" class="p-4 border rounded bg-white relative">
                <button onclick="this.parentElement.remove()" class="absolute top-2 right-2 text-red-500 font-bold">X</button>
                <input type="text" value="${title}" placeholder="Titre du bloc" class="w-full p-2 mb-2 border-b font-bold outline-none">
                <textarea id="${id}">${content}</textarea>
            </div>`;
            container.insertAdjacentHTML('beforeend', html);
            ClassicEditor.create(document.querySelector(`#${id}`)).then(ed => window.editors[id] = ed);
        };

        window.publishContent = () => {
            const lesson = {
                classe: document.getElementById('adm-classe').value,
                matiere: document.getElementById('adm-matiere').value,
                chapitre: document.getElementById('adm-chapitre').value,
                sections: []
            };
            const blocks = document.querySelectorAll('#dynamic-sections-container > div');
            blocks.forEach(div => {
                lesson.sections.push({
                    title: div.querySelector('input').value,
                    body: window.editors[div.querySelector('textarea').id].getData()
                });
            });
            push(ref(db, 'lessons'), lesson).then(() => {
                alert("Cours publié !");
                location.reload();
            });
        };

        // Gestion Fiches
        window.updateFicheSelect = () => {
            const select = document.getElementById('fiche-lesson-id');
            select.innerHTML = window.lessons.map(l => `<option value="${l.fbKey}">${l.chapitre} (${l.classe})</option>`).join('');
        };

        window.saveFiche = () => {
            const id = document.getElementById('fiche-lesson-id').value;
            const fiche = {
                niveau: document.getElementById('f-niveau').value,
                discipline: document.getElementById('f-discipline').value,
                objDisc: document.getElementById('f-obj-disc').value,
                objLang: document.getElementById('f-obj-lang').value,
                competences: document.getElementById('f-competences').value,
                phases: document.getElementById('f-phases').value,
                code: document.getElementById('fiche-download-code').value,
                date: new Date().toLocaleDateString('fr-FR')
            };
            set(ref(db, 'fiches/' + id), fiche).then(() => alert("Fiche enregistrée !"));
        };

        // Gestion Utilisateurs
        window.addNewUser = () => {
            const name = document.getElementById('u-name').value;
            const type = document.getElementById('u-type').value;
            const resp = document.getElementById('u-resp').value;
            const id = name.toLowerCase().replace(/\s/g, '').slice(0,5) + Math.floor(100+Math.random()*899);
            const pass = Math.random().toString(36).slice(-5).toUpperCase();
            push(ref(db, 'users'), { name, type, resp, id, pass });
        };

        window.deleteUser = (key) => {
            if(confirm("Supprimer cet utilisateur ?")) remove(ref(db, 'users/' + key));
        };

        window.renderUserTable = () => {
            const tbody = document.getElementById('user-table-body');
            tbody.innerHTML = window.users.map(u => `
                <tr class="text-xs border-b">
                    <td class="p-2"><b>${u.name}</b></td>
                    <td class="p-2">${u.id} / ${u.pass}</td>
                    <td class="p-2">${u.type} (${u.resp})</td>
                    <td class="p-2"><button onclick="deleteUser('${u.fbKey}')" class="text-red-500"><i class="fas fa-trash"></i></button></td>
                </tr>`).join('');
        };

        // Student View Functions
        window.loginUser = () => {
            const id = document.getElementById('stu-id').value;
            const pass = document.getElementById('stu-pass').value;
            const user = window.users.find(u => u.id === id && u.pass === pass);
            if(user) {
                window.currentUser = user;
                showSection('student-view');
                updateStudentSidebar();
            } else {
                document.getElementById('stu-error').classList.remove('hidden');
            }
        };

        window.updateStudentSidebar = () => {
            const list = document.getElementById('course-list-sidebar');
            list.innerHTML = window.lessons
                .filter(l => l.classe.toLowerCase() === window.currentUser.resp.toLowerCase())
                .map(l => `<li onclick="viewLesson('${l.fbKey}')" class="p-3 sidebar-link bg-slate-50 border-l-4 border-blue-900 font-bold text-xs">${l.chapitre}</li>`).join('');
        };

        window.viewLesson = (key) => {
            window.currentLessonKey = key;
            const l = window.lessons.find(x => x.fbKey === key);
            let html = `<h2 class="text-3xl font-extrabold text-blue-900 mb-6">${l.chapitre}</h2>`;
            l.sections.forEach(s => {
                html += `<div class="mb-8"><h3 class="text-xl font-bold border-b-2 border-blue-100 pb-2 mb-4">${s.title}</h3><div class="prose max-w-none">${s.body}</div></div>`;
            });
            document.getElementById('user-content-area').innerHTML = html;
            toggleUserSubTab('cours');
        };

        window.toggleUserSubTab = (mode) => {
            const btnCours = document.getElementById('btn-view-cours');
            const btnFiche = document.getElementById('btn-view-fiche');
            
            if(mode === 'cours') {
                btnCours.className = "py-4 px-2 tab-nav-active";
                btnFiche.className = "py-4 px-2 text-gray-400";
                if(window.currentLessonKey) viewLesson(window.currentLessonKey);
            } else {
                if(window.currentUser.type !== 'Enseignant') {
                    alert("Accès réservé aux enseignants.");
                    return;
                }
                btnFiche.className = "py-4 px-2 tab-nav-active";
                btnCours.className = "py-4 px-2 text-gray-400";
                showFicheAuth();
            }
        };

        window.showFicheAuth = () => {
            const area = document.getElementById('user-content-area');
            area.innerHTML = `
                <div class="max-w-md mx-auto text-center py-10">
                    <i class="fas fa-lock text-4xl text-amber-500 mb-4"></i>
                    <h3 class="text-xl font-bold mb-4">Autorisation requise</h3>
                    <input type="text" id="access-code" placeholder="Entrez le code administrateur" class="w-full p-3 border rounded mb-4 text-center">
                    <button onclick="verifyFicheCode()" class="bg-blue-600 text-white px-6 py-2 rounded font-bold w-full">Vérifier et afficher</button>
                </div>`;
        };

        window.verifyFicheCode = () => {
            const code = document.getElementById('access-code').value;
            const fiche = window.fiches[window.currentLessonKey];
            if(fiche && code === fiche.code) {
                renderFicheTable(fiche);
            } else {
                alert("Code incorrect ou aucune fiche pour ce chapitre.");
            }
        };

        window.renderFicheTable = (f) => {
            const lesson = window.lessons.find(l => l.fbKey === window.currentLessonKey);
            const html = `
                <div class="flex justify-between items-center mb-6 no-print">
                    <h2 class="font-bold text-xl">Fiche de préparation</h2>
                    <button onclick="downloadPDF()" class="bg-red-600 text-white px-4 py-2 rounded text-sm font-bold">
                        <i class="fas fa-file-pdf mr-2"></i>Télécharger PDF
                    </button>
                </div>
                <div id="fiche-to-print" class="p-4 border bg-white">
                    <table class="fiche-table">
                        <tr>
                            <td colspan="2"><b>Niveau :</b> ${f.niveau}</td>
                            <td colspan="2" class="text-center"><b>Titre de la séance :</b><br>${lesson.chapitre}</td>
                            <td colspan="2"><b>Date :</b> ${f.date}</td>
                        </tr>
                        <tr>
                            <td colspan="3">
                                <b>Objectif disciplinaire :</b><br>${f.objDisc}<br><br>
                                <b>Objectif langagier :</b><br>${f.objLang}
                            </td>
                            <td colspan="3">
                                <b>Connaissances et capacités :</b><br>${f.competences}
                            </td>
                        </tr>
                        <tr class="fiche-header">
                            <td>Phase</td>
                            <td>Organisation</td>
                            <td>Rôle Enseignant</td>
                            <td>Tâche Élève</td>
                            <td colspan="2">Médiation</td>
                        </tr>
                        <tr>
                            <td colspan="6" class="p-0">
                                <div class="min-h-[400px] p-2">${f.phases}</div>
                            </td>
                        </tr>
                    </table>
                    <div class="mt-4 text-[9px] text-gray-400 italic">Document généré par EDU-PORTAL - Christian Fanera</div>
                </div>`;
            document.getElementById('user-content-area').innerHTML = html;
        };

        window.downloadPDF = () => {
            const element = document.getElementById('fiche-to-print');
            html2pdf().from(element).set({
                margin: 10,
                filename: 'Fiche_Preparation.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' }
            }).save();
        };

    </script>

    <footer class="mt-20 p-10 bg-slate-900 text-white text-center">
        <div class="max-w-2xl mx-auto opacity-70">
            <p class="font-bold">TSIMANIRIMANANA Fanera Christian</p>
            <p class="text-sm">Créateur de contenu - Études en Sciences de l'éducation (Master II)</p>
            <p class="text-xs mt-2">Contact : tsiryfanera@gmail.com | 0336485137</p>
        </div>
    </footer>

</body>
</html>
